<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Navbar Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <%= javascript_include_tag "application" %>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href ="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" rel="javascripts"> 
    <script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
    <script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

  </head>

  <body>
    <div class="container">
      <!-- Static navbar -->
      <div class="navbar navbar-default" role="navigation">

        <% if user_signed_in? %>

          <div class="container-fluid">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">Carpool</a>
            </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">
                <li style = "padding-top: 15px; padding-left: 30px;" >
                  Welcome <strong><%= current_user.name.to_s + " " + current_user.lastname.to_s%></strong>.
                </li>
              </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="active"><a>
                <%= link_to 'Edit profile', edit_user_registration_path, :class => 'navbar-link' %>
              </a></li>
              <li><a>
              <%= link_to "Logout", destroy_user_session_path, method: :delete, :class => 'navbar-link'  %>
              </a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container-fluid -->
        <div class="jumbotron">
          <% if current_user.latitude != nil %>
            <h3>People living close to you</h3>
            <% vector2 = Hash.new %>
            <% User.all.each do |u|%>
              <% if u != current_user %>
                <% if u.latitude != nil %>
                  <% vector2 = vector2.merge( {u => Geocoder::Calculations.distance_between([u.latitude,u.longitude], [current_user.latitude,current_user.longitude])})%>
                <% end %>
              <% end %>
            <% end %>
            <% vector2 = vector2.sort_by {|name, distance| distance} %>
            <table class="table table-bordered table-hover" style = "width:300px; background-color: #FFFFFF ">
              <% for i in 0..4%>
                <tr>
                  <th>
                    <% if vector2[i].first.drive %>
                      <%= image_tag("driver.jpg", size: "32x32") %>
                    <% else %>
                      <%= image_tag("passenger.jpg", size: "32x32") %>
                    <% end %>
                  </th>
                  <th>
                    <%= link_to vector2[i].first.name, user_show_path(vector2[i].first.id)%>
                  </th>
                  <th style = "width:170px">
                    <%= vector2[i].second.round(1).to_s + " miles"  %>
                  </th>
                  <th>
                    <%= link_to "mailto:#{vector2[i].first.email}?subject=Let's carpool!&body=Hi, I saw you in carpool and uhul i love carpool" do %>
                      <%= image_tag("email.jpg", size: "32x32") %>
                    <% end %>
                  </th>
                </tr>
              <% end %>
            </table>
          <% else %>
            <h4 class="alert alert-error" style="color: red">
              We could not find your address, please set a valid address for your profile!
            </h3>
          <% end %>
          <br>
          <h3>Suggested rides:</h3>
          <% dis_max = 4%>
          <% vector_sug = Array.new %>
          <% if vector2 %>
            <% vector2.each_with_index do |v,i| %>
              <% if i < 5 %>
                <% if v.second < dis_max %>
                  <% vector_sug << v.first %>
                <% end %>
              <% end %>
            <% end %>
            <% if vector_sug.size > 0 %>
              <% if vector_sug.size > 3 %>
                <% num = 3 %>
              <% else %>
                <% num = vector_sug.size %>
              <% end %>
              <div class="row">
              <% vector_sug.combination(num).to_a.each do |v| %>
                <% num_drivers = 0 %>
                <% v.each do |t| %>
                  <% if t.drive %>
                    <% num_drivers = num_drivers+1 %>
                  <% end %>
                <% end %>
                <% if num_drivers > 0 %>
                  <table class="table table-bordered table-hover col-md-6" style = "width:150px; background-color: #FFFFFF ">
                    <tr>
                        <th>
                          Group
                        </th>
                    </tr>
                    <% v_emails = "" %>
                    <% v_total_dist = 0 %>
                    <% v.each do |f| %>
                      <% v_emails += f.email.to_s + "; " %>
                      <% v_total_dist += Geocoder::Calculations.distance_between([f.latitude,f.longitude], [current_user.latitude,current_user.longitude]) %>
                    <% end %>
                    <% v.each do |vv| %>
                      <tr>
                        <th>
                          <% if vv.drive %>
                            <%= image_tag("driver.jpg", size: "32x32") %>
                          <% else %>
                            <%= image_tag("passenger.jpg", size: "32x32") %>
                          <% end %>
                        </th>
                        <th>
                          <%= link_to vv.name, user_show_path(vv.id)%>
                        </th>
                      </tr>
                    <% end %>
                    <tr>
                      <th>
                        <% if current_user.drive %>
                          <%= image_tag("driver.jpg", size: "32x32") %>
                        <% else %>
                          <%= image_tag("passenger.jpg", size: "32x32") %>
                        <% end %>
                      </th>
                      <th>
                        You
                      </th>
                    </tr>
                    <tr>
                      <th>
                        <%= image_tag("gas.png", size: "32x32") %>
                      </th>
                      <th>
                        <% gal_save = ((v_total_dist/4)/23*v.size*2*20).round(2) %>
                        <%= gal_save.to_s + ' gallons saved/month' %>
                      </th>
                    </tr>
                    <tr>
                    <tr>
                      <th>
                        <%= image_tag("money.png", size: "32x32") %>
                      </th>
                      <th>
                        <%= (gal_save*3.61).round(2).to_s + ' dollars saved/month' %>
                      </th>
                    </tr>
                    <tr>
                        <th>
                          <%= link_to "mailto:#{v_emails}?subject=Let's carpool!&body=Hi, I saw you in carpool and uhul i love carpool" do %>
                            <%= image_tag("email.jpg", size: "32x32", :align=> "middle") %>
                          <% end %>
                        </th>
                        <th>
                          email group!
                        </th>
                    </tr>

                    <br>
                  <% end %>
                <% end %>
              <% end %>
              </div>
          <% end %>
          </table>

          <div style='width: 800px;'>
            <div id="map" style='width: 800px; height: 400px; border-width: 3px; border-style: solid; border-color: #ccc #ccc #999 #ccc;'></div>
          </div>  

          <script type="text/javascript">
          handler = Gmaps.build('Google');
          var directionsDisplay = new google.maps.DirectionsRenderer();
          var directionsService = new google.maps.DirectionsService();
          function calcRoute() {
            var destination = new google.maps.LatLng(30.2378944249208, -97.8637985564374);
            <% if current_user.latitude != nil %>
              var origin  = new google.maps.LatLng(<%= current_user.latitude %>, <%= current_user.longitude %>);
            <% else %>
              var origin = destination;
            <% end %>
            var request = {
                origin:      origin,
                destination: destination,
                travelMode:  google.maps.TravelMode.DRIVING
            };
            directionsService.route(request, function(response, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
              }
            });
          }
          handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
            calcRoute(); // call this anywhere you want
            directionsDisplay.setMap(handler.getMap())
            directionsDisplay.setOptions( { suppressMarkers: true } );
            markers = handler.addMarkers([
              <% User.all.each do |u| %>
                <% if u.latitude != nil %>
                  <% if u != current_user %>
                    {
                      "lat": <%= u.latitude %>,
                      "lng": <%= u.longitude %>,
                      "infowindow": "hello!"            
                    },
                  <% end %>
                <% end %>
              <% end %>
              <% if current_user.latitude != nil %>
                {
                  "lat": <%= current_user.latitude %>,
                  "lng": <%= current_user.longitude %>,
                  "picture": {
                    "url": "https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTMT9Mbr7XsOwQPruLsvbjqITMalRRG4KWc1rYTLp47V98dKUgCSin-LA",
                    "width":  32,
                    "height": 32
                  },
                  "infowindow": "home!"              
                },
              <% end %>
              {
                "lat": 30.2378944249208,
                "lng": -97.8637985564374,
                "picture": {
                  "url": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNvUUkLpyrEsU70UOZgZB2YKyOS31gSBmWzAe_9F09KKVsaKC1Og",
                  "width":  32,
                  "height": 32
                },
                "infowindow": "freescale!"
              }
            ]
            );
            handler.bounds.extendWith(markers);
            handler.fitMapToBounds();
          });
          </script>



        </div>



        <% else %>

          <div class="container-fluid">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">Carpool</a>
            </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">
              </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="active"><a>
                <%= link_to "Sign up", new_user_registration_path, :class => 'navbar-link'  %>
              </a></li>
              <li><a>
                <%= link_to "Login", new_user_session_path, :class => 'navbar-link'  %>
              </a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container-fluid -->
        <div class="jumbotron">
          <%= image_tag "road.jpg", size: "800x400", :style => "opacity:0.7; filter:alpha(opacity=50);" %>
        </div>

        <% end %>

      </div>

      <!-- Main component for a primary marketing message or call to action -->

    </div> 


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </body>
</html>
